Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Differentiated Products Supply and Demand
Phil Haile
Yale University

Fall 2025

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Outline (2-3 class meetings)

1. Differentiated Products Supply
2. Berry-Levinsohn-Pakes (“BLP”) Demand Model
3. BLP Estimator and Instruments
4. Estimation Algorithms

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Motivation

IO is mostly about market power:
• sources

• implications for profits and firm incentives
• impact on consumers
• effects of policy

Standard models of firms with market power: Oligopoly. Typically, some form of
differentiated products competition in prices.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Oligopoly Supply

Baseline workhorse model:
• firms produce differentiated goods/products, selling to consumers with
heterogeneous preferences
• static model, complete information (model of long run eqm)
▶ set of products, their non-price characteristics already set
▶ Nash eqm in simultaneous price setting game in each market
market usually defined by time or geography in practice.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Firm Cost Functions
Variable cost Cj (Qj , wjt , ωjt , γ) for product j
• Qj total quantity of good j sold

• wjt observable cost shifters; may include product characteristics xjt that will affect
demand (later)
• ωjt unobserved cost shifters (“cost shocks”); may be correlated with latent demand
shocks (later)
• γ parameters
• for multi-product firms, we’ll assume variable cost additive across products for
simplicity

We will ignore fixed costs: these affect entry/exit/innovation (later) but not pricing conditional on these
things.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Demand

Notation
• Jt products/goods/choices in market t (for now Jt = J)
• pt = (p1t , . . . , pJt ), prices of all goods

• χt = (χ1t , . . . , χJt ), other characteristics of goods affecting demand (observed and
unobserved to us)
Demand system:
qjt = qj (pt , χt )

j = 1, . . . , J.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Equilibrium Pricing
With single-product firms and constant marginal cost (simple case)
πjt = qj (pt , χt ) [pjt − mcj (wjt , ωjt , γ)]
FOC wrt to pjt :

pjt = mcjt − qj (pt , χt )

∂qj
∂pjt

−1

This is inverse elasticity pricing (i.e., monopoly pricing) against the “residual demand
curve” qj (pt , χt ) :


pjt − mcjt
qj (pt , χt ) ∂qj −1
=−
.
pjt
pjt
∂pjt

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Equilibrium Pricing with Multi-Product Firms
With multi-product firms, firm f ’s profit is
X
Πft =
πjt
j∈Jf

X

=

j∈Jf

h
i
qj (pt , χt ) pjt − mcj (wjt , ωjt , γ)

FOC wrt pj :

pjt = mcjt −

∂qj
∂pjt

−1


qj (pt , χt ) +



X
k∈Jf \{j}

∂qk
(pkt − mckt )
∂pjt

(firm internalizes effects of pjt on profit from all of its products).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Supply Model
What we get from this. . .
1. Holding all else fixed, markups/prices depend on the own- and cross-price
elasticities of residual demand.
=⇒ For good quantitative predictions of firm behavior and market outcomes, we
will need good estimates of demand (at least the own- and cross-price derivatives)

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Supply Model
What we get from this. . .
2. If we know demand, we can also perform a small miracle:
▶ re-arrange FOC above:

mcjt = pjt + qj (pt , χt )

∂qj
∂pjt

−1

eqm (p, q) + supply model + estimated demand→estimates of marg costs!

▶ with multiproduct firms, same thing in system of equations:


−1

X ∂qk
∂qj
qj (pt , χt ) +
mcjt = pjt +
(pkt − mckt )
∂pjt
∂pjt
k∈Jf \{j}

[see Rosse (1970), Bresnahan (1981, 1987), BLP (1995), Berry-Haile (2014)].

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Supply Model
What we get from this. . .
3. If we know demand and marginal costs, we can“predict” a lot of things—i.e., give
the quantitative implications of the model for counterfactual worlds: e.g., what
prices, consumer choices, profits, consumer welfare . . . if
▶ products were less differentiated?
▶ a tax or tariff were imposed?
▶ two suppliers merged?
▶ a certain new product had not been introduced?
▶ school vouchers were provided to poor students?
▶ ...

Demand can be important on its own. But good demand estimates open a world of
possibilities for answering questions about markets and competition policy.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Demand Isn’t Easy
Typically we need to know levels/elasticities of demand at particular points; i.e., effects
of one price change holding all else fixed. “Local average effects” don’t reveal these.
The main challenge: unobserved demand shifters (“demand shocks”) at the level of the
good×market—e.g., unobserved product characteristics or cross-market differences in
tastes (important to acknowledge: not everything is observed!)
• demand shocks are among the things that must be held fixed to measure the
relevant demand elasticities etc.
Explicit modeling of these demand shocks central in the applied IO literature following
Berry-Levinsohn-Pakes 1995 (and often ignored outside this literature). Handling them
correctly requires approaches outside the basic toolkit of applied micro!

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

A Key Challenge

Econ 115: the quantity demanded of a given good j depends on the prices and
characteristics of all related goods (substitutes and complements). This includes the
latent demand shocks associated with all of those goods.
How do we hold something fixed if it isn’t observed?

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

The Demand System

With J related goods, demand for each one takes the form
qj = D(x, p, ξ)
where
• p is a J-vector of all goods’ prices.

• x is the matrix of all non-price observables

• ξ is a J-vector of demand shocks for all goods.

This is a system of J equations, all depending on all elements of (x, p, ξ).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Supply

Demand Is Not Regression
qj = Dj (x, p, ξ)
• RHS has many latent shocks;

• Dj is a standard regression function only under a strong functional form
assumption: that the J components of ξ enter Dj only through a scalar index
• applying regression methods to (1) might allow one to recover certain weighted
average derivatives of demand, but those have little value
⇒ not obvious how to proceed, even if prices were exogenous!
let that sink in

(1)

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Price Endogeneity Adds to the Challenge

• all J endogenous prices are on RHS of demand for each good
• eqm pricing implies that each price depends on all demand shocks and all cost
shocks
→ prices are endogenous (e.g., correlated with ξ vector)
→ control function generally is not a valid solution (Blundell & Matzkin, 2014)

• clear that we need sources of exogenous price variation, but
▶ what exactly is required?
▶ how do we proceed?

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Ways Forward
A common approach starts by building up a demand system from a smaller set of
parameters appearing in a specification of consumer utilities.
And we’ll use a“trick” (a useful mathematical result) to deal with the fact that each
good’s demand is affected by J structural errors.
Notes:
• deriving demand from utilities offers parsimony: many own- and cross-price
elasticities from a modest number of parameters
• it also offers a way to impose some natural exclusivity or symmetry conditions
• but is isn’t essential

• the trick (or some other trick) is essential.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: RANDOM UTILITY DISCRETE CHOICE

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Discrete Choice Demand

The choice setting
• consumers have unit demands, choose one of the available options

• generally, one option should be “none of the above” — what we will call
the“outside good” (without this, there would be no aggregate demand elasticity!)

Note: discrete choice is more general than it seems; e.g., a single option for a consumer could be
{Dodge Caravan + Porsche 911} or {four boxes of cookies + a gallon of milk}. Many key insights we’ll
cover here extend to models of “multiple discrete choice” or continuous choice.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Random Utility Discrete Choice
Random Utility Specification
• differentiated goods j ∈ {1, . . . J}

• conditional indirect utilities of consumer i: uij (“utility”)
• (ui1 , . . . , uiJ ) ∼ Fu (·) for all i
• outside good 0

▶ only utility differences matter, so wlog. we could set ui0 = 0∀i—or give it any
distribution we want— i.e., we may (must!) normalize its distribution.

[Aside: correct use of the term “normalization” is always like this—for an assumption one may make
without loss and, therefore, must make to avoid trivial indeterminacy. The only nuance: without loss for
what purpose?]

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Choice Probabilities From the Model
• consumer i’s choice (quantities)
qij = 1{uij ≥ uik ∀k = 0, . . . , J}
(typical assumptions imply ties happen w/probability zero)

• choice probabilities
sij

= Pr (qij = 1)
Z
=
dFU (ui1 , . . . , uiJ )
Aj

where

n
o
Aj = (ui1 , . . . , uiJ ) ∈ RJ : uij ≥ uik ∀k .

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Example: J = 2, ui0 = 0, uij = µij − pj

Estimator

Computation

j = 1, 2

µi2
45◦

A2
p2

A1

A0
(0, 0)

p1

µi1

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Demand and Utility
Some Comments
• utility maximization is one (often convenient) way to represent how consumers
make choices
• but demand is well-defined without this — consumers need not maximize utilities or
have complete information, e.g.,
• indeed, utility is a notion we make up, and representing demand with utility
maximization requires extra assumptions
• relatedly, randomness in the “utilities” could instead reflect noise/errors in
consumer choice (e.g., Luce, 1959)
▶ profit-maximizing firms don’t care what the randomness represents (unless they can
affect it)
▶ but the interpretation will matter for welfare—one in a long list of reasons one must
be especially careful about welfare analysis.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: BLP DEMAND MODEL

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Berry, Levinsohn, and Pakes (1995) “BLP”

This is the standard empirical model of demand and supply of differentiated products in
IO and beyond.
Many of the ideas also in Berry (1994), mostly for simpler models. Read this first!
Many extensions and variations, some of which we will get to.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Some Goals in BLP

1. parsimonious specification to generate the distribution FU (·|p, χ) of random
utilities and, thus, demand
2. sufficiently rich heterogeneity in preferences to permit reasonable/flexible
substitution patterns
3. explicit treatment of demand shocks and the resulting endogeneity “problem(s)”
4. clarify the identification challenges and possible solutions, including appropriate
instruments
5. computationally feasible (in early 1990s!) algorithm for consistent estimation of the
model and standard errors.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

BLP Random Utility Specification
(slightly simplified)
uijt = xjt βit − αpjt + ξjt + ϵijt
• consumer i, good/product j, market t

(imagine setting with many markets, each with many consumers)

• price pjt

• xjt ∈ RK non-price observables (product or market characteristics)
• ξjt unobserved demand shock at level of product×market

• ϵijt idiosyncratic (and latent)“taste for product j”

...

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Preference Heterogeneity
uijt = xjt βit − αpjt + ξjt + ϵijt
Sources of consumer heterogeneity: ϵijt , βit = βit1 , . . . , βitK
• βitk = β0k + σk ζitk


(k)

(“random coefficient” = taste for xjt )

• (ϵi0t , . . . , ϵiJt , ζit1 , . . . , ζitK ) i.i.d. across csrs and mkts
• typically:

▶ ϵijt ∼ i.i.d. type 1 extreme value (like multinomial logit)
▶ ζitk ∼ i.i.d. standard normal, or drawn from actual distribution of demographics (e.g.,
income) in market t. Or could have both.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Supply

Exogenous and Endogenous Product Characteristics
Recall
uijt = xjt βit − αpjt + ξjt + ϵijt

(2)

• exogenous characteristics: xt satisfy E [ξt |xt ] = 0

• endogenous characteristics: pjt (usually a scalar, price)

▶ typically each pjt will depend on whole vector ξt = (ξ1t , . . . , ξJt )
(also on own and others’ product characteristics and costs)
▶ we need to distinguish true effects of prices on demand from the effects of ξt ; this will
require instruments

• of course (2) is not an estimating equation (uijt is not observed)

• because prices and quantities are all endogenous, you may suspect (correctly) that
instruments for prices alone may not suffice. More on this to come.

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Utility Specification, Rewritten
Rewrite
uijt

= xjt βit − αpjt + ξjt + ϵijt
= δjt + νijt

where
δjt
νijt

= xjt β0 − αpjt + ξjt
X
=
xjtk σ k ζitk + ϵijt

(“mean utility” of good j in market t)

k

≡ xjt β̃it + ϵijt (defining β̃it —the random part of βit ).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Market Shares
• recall uijt = δjt + νijt

• let δ0t = 0 (the normalization); define δt = (δ1t , . . . , δJt )

• ≈ continuum of consumers in each market*
=⇒ market shares = choice probabilities =
Z
sjt = Pr (yit = j) =
dFν (νi0t , νi1t , . . . , νiJt )
Aj (δt )

where
n
o
Aj (δt ) = (νi0t , νi1t , . . . , νiJt ) ∈ RJ+1 : δjt + νijt ≥ δkt + νikt ∀k
* really, enough that sampling error on choice probabilities is negligible compared to that of moments
based on variation across products/markets.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Demand
• market shares again
Z
dFν (νi0t , νi1t , . . . , νiJt )

sjt =
Aj (δt )

• with random coefficients, Fν (·) is really Fν (·|xt , σ) where
▶ xt = (x1t , . . . , xJt ) ∈ RK ×J
▶ σ = (σ 1 , . . . , σ K )

• so sjt = sj (δt , xt , σ)

• if Mt is the total measure of consumers in market t, quantities demanded are
qjt = Mt × sj (δt , xt , σ) .

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Discussion
Key features of the BLP model
• explicit modeling of demand shocks

• consumer heterogeneity through random coefficients

We discussed the need to be explicit about demand shocks—only then can we (a) define
“ceteris paribus,” (b) define the endogeneity problem, (c) determine what are valid
solutions.
Why random coefficients? A parsimonious way to allow “reasonable” “substitution
patterns.”

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Why Random Coefficients?
Without random coefficients:
uijt

= xjt β0 − αpjt + ξjt +ϵijt
{z
}
|
=
δjt
+ ϵijt

If ϵijt are iid and independent of (x, p), e.g. as in the multinomial logit or probit models,
products differ only in δjt
• =⇒ market shares depend only on the mean utilities;
• =⇒ price elasticities (own and cross) depend only on mean utilities too.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Example

Two autos with (virtually) identical market shares in 2024:
MSRP (base)

Mkt Share

Automobile 1

1.2%

Automobile 2

1.2%

Without random coefficients, model implies same mean utility for each and therefore:
same own-price demand elasticity, same cross-price elasticity wrt price of any third
automobile, say Ford F-series pickup (#1 market share) or Toyota Camry (2nd
best-selling sedan).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Example

Two autos with (virtually) identical market shares in 2024:
MSRP (base)

Mkt Share

Automobile 1

$31,500

1.2%

Automobile 2

$40,400

1.2%

Without random coefficients, model implies same mean utility for each and therefore:
same own-price demand elasticity, same cross-price elasticity wrt price of any third
automobile, say Ford F-series pickup (#1 market share) or Toyota Camry (2nd
best-selling sedan).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Example

Two autos with (virtually) identical market shares in 2024:
MSRP (base)

Mkt Share

Toyota Tacoma

$31,500

1.2%

Tesla 3

$40,400

1.2%

Without random coefficients, model implies same mean utility for each and therefore:
same own-price demand elasticity, same cross-price elasticity wrt price of any third
automobile, say Ford F-series pickup (#1 market share) or Toyota Camry (2nd
best-selling sedan).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Logit and IIA

What I’ve said so far doesn’t depend on the distribution ϵijt are drawn from. In the logit
model, market shares, elasticities, and substitution patters have simple closed forms in
which, e.g., substitution is always proportional to market shares. These particular closed
forms are features of the “IIA” property.
But although the exact IIA property is unique to the logit, other specifications of iid
epsilons have the same types of problems.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Does this matter?

Yes! Remember: the main reason to estimate demand is to quantify the own- and
cross-price demand responses!
• these determine responses to counterfactual changes in market structure

• these used with a model of the supply side to infer firm markups, market power,
implications of mergers, entry incentives, etc.
• these are what determine welfare effects of price changes, tax, tariff, merger,
collusion, entry, etc.

=⇒ if we impose a prior restrictions on substitution patterns, we are restricting the
model’s ability to give us useful guidance on the questions of interest.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

The Science and Art of Modeling

Models that have only iid additive taste shocks impose very restrictive relationships
between the levels of market shares and the matrix of own and cross-price derivatives
(and therefore on counterfactual predictions). These restrictions do not come from
economics but from an assumption chosen for analytical convenience.
Models must abstract from reality. And in a finite sample some kind of functional form
restrictions are always necessary for estimation. But a good model/approximation
should try to avoid placing strong arbitrary restrictions on the key quantities of interest.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

How do random coefficients help?

Real goods differ in multiple dimensions; real consumers have (heterogeneous)
preferences over these differences
• random coefficients on product characteristics can capture this

▶ large βik ⇐⇒ strong taste for characteristic x k (e.g., fuel efficiency, pickup dummy)
▶ i’s first choice likely to have high value of x k
▶ i’s second choice too! (note: cross elasticities are always about 1st vs. 2nd choices)

• incorporating this allows more sensible substitution patterns: competition is mostly
“local” – i.e., between firms offering products appealing to the same consumers.

Supply

Supply

Demand

BLP Demand

870

Discussion

Estimator

Computation

S. BERRY, J. LEVINSOHN, AND A. PAKES
TAiBLE 1
DESCRIPTIVESTATISTICS

Year

No. of
Models

Quantity

Price

Domestic

Japan

European

HP/Wt

Size

Air

MPG

MP$

1971
1972
1973
1974
1975
1976
1977
1978
1979
1980
1981
1982
1983
1984
1985
1986
1987
1988
1989
1990
All

92
89
86
72
93
99
95
95
102
103
116
110
115
113
136
130
143
150
147
131
2217

86.892 7.868
91.763 7.979
92.785 7.535
105.119 7.506
84.775 7.821
93.382 7.787
97.727 7.651
99.444 7.645
82.742 7.599
71.567 7.718
62.030 8.349
61.893 8.831
67.878 8.821
85.933 8.870
78.143 8.938
83.756 9.382
67.667 9.965
67.078 10.069
62.914 10.321
66.377 10.337
78.804 8.604

0.866
0.892
0.932
0.887
0.853
0.876
0.837
0.855
0.803
0.773
0.741
0.714
0.734
0.783
0.761
0.733
0.702
0.717
0.690
0.682
0.790

0.057
0.042
0.040
0.050
0.083
0.081
0.112
0.107
0.158
0.191
0.213
0.235
0.215
0.179
0.191
0.216
0.245
0.237
0.261
0.276
0.161

0.077
0.066
0.028
0.064
0.064
0.043
0.051
0.039
0.038
0.036
0.046
0.051
0.051
0.038
0.048
0.050
0.052
0.045
0.049
0.043
0.049

0.490
0.391
0.364
0.347
0.337
0.338
0.340
0.346
0.348
0.350
0.349
0.347
0.351
0.361
0.372
0.379
0.395
0.396
0.406
0.419
0.372

1.496
1.510
1.529
1.510
1.479
1.508
1.467
1.405
1.343
1.296
1.286
1.277
1.276
1.293
1.265
1.249
1.246
1.251
1.259
1.270
1.357

0.000
0.014
0.022
0.026
0.054
0.059
0.032
0.034
0.047
0.078
0.094
0.134
0.126
0.129
0.140
0.176
0.229
0.237
0.289
0.308
0.116

1.662
1.619
1.589
1.568
1.584
1.759
1.947
1.982
2.061
2.215
2.363
2.440
2.601
2.469
2.261
2.416
2.327
2.334
2.310
2.270
2.099

1.850
1.875
1.819
1.453
1.503
1.696
1.835
1.929
1.657
1.466
1.559
1.817
2.087
2.117
2.024
2.856
2.789
2.919
2.806
2.852
2.086

Note: The entry in each cell of the last nine columns is the sales weighted mean.

Supply

Supply

opt instead for the outside good. This figure is just so/(l - sj). The results
BLP Demand
Discussion
Estimator
Computation
under the BLP specificationare not nearlyas uniformacrossmodels. Here, the
numbersstill seem a bit large to us, which may point to the need for improveDemand

TABLE VII
SUBSTITUTION TO THE OUTSIDE GOOD

Model

Mazda 323
Nissan Sentra
Ford Escort
Chevy Cavalier
Honda Accord
Ford Taurus
Buick Century
Nissan Maxima
Acura Legend
Lincoln Town Car
Cadillac Seville
Lexus LS400
BMW 735i

Given a price increase, the percentage
who substitute to the outside good
(as a percentage of all
who substitute away.)
BLP
Logit

90.870
90.843
90.592
90.585
90.458
90.566
90.777
90.790
90.838
90.739
90.860
90.851
90.883

27.123
26.133
27.996
26.389
21.839
25.214
25.402
21.738
20.786
20.309
16.734
10.090
10.101

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Which random coefficients?

We must choose which characteristics have random coefficients
• dummies for subsets of products?

▶ this yields something equivalent (up to different distributional assumptions) to the
nested logit: see Berry (1994)

• certain horizontal or vertical characteristics (parts of X , P)?
In practice, the choice depends on the application and data set, including instruments.
Too many RC’s for the data available will often yield imprecise estimates of σ.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

NEXT: ESTIMATION OF THE BLP DEMAND MODEL

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Recall: Utility Specification, Rewritten

uijt

= xjt βit − αpjt + ξjt + ϵijt

= δjt + νijt
where
δjt
νijt

= xjt β0 − αpjt + ξjt
X
=
xjtk σ k ζitk + ϵijt

(“mean utility” of good j in market t)

k

≡ xjt β̃it + ϵijt (defining β̃it —the random part of βit ).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Estimation of Demand with Market-Level Data

Highest-Level View
• we observe xt , pt , sht ,wt , and z̃t ←excluded iv
(for clarity, shjt and sht denote the observed market shares)
• given a choice of parameters, the model predicts market shares as a function of
observables
• choose the parameters so that the predictions match the observed shares as well as
possible, while obeying (as well as possible) the assumed exogeneity conditions on
xt and wt .

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Estimation with Market-Level Data: A Partial Sketch
1. start with demand model alone
2. suppose Fν (·|xt , σ) is known (i.e., σ known)
3. for each market t, find δt ∈ RJ such that sj (δt , xt , σ) = shjt ∀j
i.e.,“invert” model at observed market shares to find mean utilities δt

4. using IV (E [ξjt |zjt ] = 0), estimate the equation
δjt = xjt β0 − αpjt + ξjt .

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Some Details to Fill In
ok . . . a lot of details

1. What instruments?
2. Will the“inversion” step actually work?
3. What about σ ??
4. Formally define estimator, computational algorithm(s)
5. Standard errors?
6. Add Supply Side
▶ additional restrictions aid estimation of demand
▶ estimate parameters γ of marginal cost function
(why? may care directly; and needed for counterfactuals that change equilibrium
quantities unless mc is constant).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: INSTRUMENTS

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Instruments for Estimating Demand

Broadly speaking, we need variables that exogenously shift all endogenous
variables—prices and quantities—independently.
This may be counterintuitive: to estimate demand, we might think instruments for
prices were all we needed. As we discussed earlier, however, exogenous variation in
prices generally doesn’t suffice: we need prices to move exogenously, but also to hold
the demand shocks fixed. More below.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Typical (Excluded) Instruments for Estimating Demand

1. Excluded cost shifters wt
▶ classic demand instrument, e.g., wages, material costs, shipping cost to market t,
taxes/tariffs, demand shifters from other markets

2. Proxies for excluded costs shifters
▶ typical: price of same good in another mkt (“Hausman instruments”); properly
excluded if demand shocks in one market not correlated with those in others

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Typical (Excluded) Instruments for Estimating Demand
3. Markup shifters
▶ exogenous changes in ownership (e.g., merger)
▶ characteristics of “nearby” consumers (“Waldfogel instruments”)
e.g., firms in some industries may use same price for all markets in a region (e.g., CT)
e.g., age/income/education in Greenwich may affect prices (markups) in New Haven,
but may be independent of New Haven preferences (including New Haven demand
shocks) conditional on New Haven observables

4. “BLP Instruments” x−jt
▶ by assumption, E [ξjt |xt ] = E [ξjt ]
▶ affect quantities directly; affect prices (markups) via FOC

Later: “optimal instruments” — i.e., optimal functions of the excluded instruments for
estimating the unconditional moments.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: INVERSION

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Will the Inversion Step Work?
Given x, σ and any positive shares sh, define Φ : RJ → RJ by
Φ (δ) = δ + ln (sh) − ln (s (δ, x, σ))
BLP show (under mild conditions on the linear random coefficients random utility
model) that for any nonzero shares sh, Φ is a contraction, i.e.,
• it has a unique fixed point in δ

▶ s (δt , xt , σ) has an inverse: we can write δt = δ (st ; xt , σ) (see also Berry, 1994)

• ∃ convergent algorithm: start with guess δ 0 , set c = 1

1. let δ c = Φ δ c−1 , c = 1, 2, . . . ,
2. repeat to convergence

(invertibility for more general models: Berry, Gandhi, & Haile, 2013).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: Identification?

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

What About sigma??
• inversion result =⇒ for any market shares st and any σ, we can find a vector δt
that rationalizes the data (fits market shares perfectly)
• a non-identification result? there is NO information about σ from market shares?
What are we forgetting?
• variation across markets (and products): the structural errors
ξjt = δjt − xjt β0 − αpjt implied by candidate (α, β, σ) must be mean-independent of
exogenous observables across markets and products
• (this is just like linear regression: for any (x, y , β) ∃e such that y = xβ + e, but
x ⊥ e is what ensures identification of β).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Identification of sigma: loose nonparametric intuition
Changes in choice sets
• recall sjt = s (δt , xt , σ)

• consider two markets, same pt , xt , ξt in each

• remove 1 car in one of them. . . where does its mkt share “go”?
▶ to cars with large mkt shares?
▶ to cars similar to the one removed in some dimension(s)?

• similar idea with cts variation across/within markets
One source of the looseness: how can we fix ξt = (ξ1t , . . . , ξJt ) in two markets when ξt is latent??
Instruments will shift things independently of ξt , but this isn’t the same as fixing them! In reality,
instruments for quantities are what enable us to hold ξt fixed. More on this later.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Identification of sigma: parametric intuition
Counting parameters and moments:
• trial value of σ =⇒ δt (sht ; x, σ) by inversion
• with trial value of α, β =⇒ ξt (σ, α, β)

• IV orthogonality condition: E [ξjt (σ, α, β) Zjt ] = 0 ∀j, t

• what kind of Z do we need? we need at least as many moment conditions as
parameters
▶ =⇒ xjt plus excluded IV for price is not enough: (α, β) are not all the parameters!
▶ to identify σ, we need additional excluded instruments.

A minimal requirement: as many exogenous variables as we have parameters in the
model.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Nonparametric Identification of Demand
Even if considerations lead to reliance on parsimonious parametric specifications, we’d
like to know what does (or does not) permit identification without such restrictions.
Berry and Haile (2014) examine a nonparametric generalization of the BLP demand
model using market-level data. The main requirement: instruments creating
independent exogenous variation in all 2J endogenous variables: prices and quantities:
• intuitively: move 1 price; hold fixed J − 1 prices and J demand shocks → 2J

• instruments: “BLP instruments” (exogenous characteristics of other products) plus
J others (shifters of costs or markups)

Details later in the course, including more clarity about why the BLP instruments are
valid and necessary.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: ESTIMATION DETAIL

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Basic Idea for BLP Estimator (demand alone)
idea: method of moments estimator
• any guess at the parameters (σ, α, β) implies (after inversion) values ξjt (σ, α, β) for
the latent demand shocks rationalizing the data
• moments conditions: E [ξjt (σ, α, β) zjt ] = 0
1
• sample analog E [ξjt (σ, α, β) zjt ] ≈ JT
ξjt (σ, α, β) zjt

• GMM estimator


▶ σ̂, α̂, β̂ chosen to make sample analog close to zero
▶ optimal weighting of moments for efficiency

Note: this means fitting market shares exactly, orthogonality as close as possible, based
on large (→ ∞ faster than J) number of consumers per market.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Some Complications
1. model predictions sj (δt , xt , σ) involve high-dimensional integrals (recall 2-D picture)
▶ use simulation to approximate
▶ =⇒ “method of simulated moments”

2. moment conditions involve ξt (σ, α, β), which has no closed form →two options for
computation of the estimator:
(i) solve contraction at each trial value of (σ, α, β)
=⇒ “nested fixed point” algorithm (BLP; or)
(ii) forget about contraction, solve the BLP constrained optimization problem directly
using specialized algorithms adapted to the BLP details (Dube-Fox-Su, 2012)

(we’ll discuss both options soon).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Defining the Estimator

Notation
• let θ = (θ1 , θ2 ) = ([α, β0 ], σ)

• let Zjt denote the exogenous variables (xjt , wjt , z̃jt )

• let δjt (θ2 ) be shorthand for δj (sht ; xt , σ) .

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

The BLP Estimator
GMM estimator of θ defined as solution to mathematical program:

min
θ

g (ξ(θ)) =

g (ξ (θ))′ Ωg (ξ (θ))

s.t.

1 X
ξjt (θ)zjt
N
∀j,t

ξjt (θ) = δjt (θ2 ) − xjt β − αpjt

log(shjt ) = log(sj (δt , xt , θ2 ))
Z
exp[δjt (θ2 ) + xjt β̃]
f (β̃|θ2 )d β̃i
sj (δt , xt , θ2 ) =
P
1 + k exp[δjt (θ2 ) + xkt β̃] β̃
Ω = standard GMM weight matrix.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: COMPUTATION OF THE BLP ESTIMATOR

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

BLP Estimation Algorithm (Sketch)
“Nested Fixed Point” algorithm (used for other things too)
• Outer Loop: search over trial values of θ
• Inner Loop: given θ, find solution for ξ(θ)

▶ given θ2 , solve for δ (θ2 ) as fixed point of contraction mapping
▶ then ξjt (θ) = δ (θ2 ) + αpjt − xjt β0

begin outer loop
try new θ
begin inner loop
solve contraction
end inner loop
calculate GMM criterion
end outer loop

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

BLP Estimation Algorithm: More Detail
1. set up approximation of predicted shares (given θ) via simulation
▶ draw values of ζitk from normal distribution→ β̃it
▶ take many draws to simulate population of csrs:
R
exp[xjt β̃it +δjt ]
sj (xt , δt , θ2 ) = 1+P exp[x
f (β̃it |θ)d β̃it
j ′ t β̃it +δjt ]
j′
P
exp[xjt β̃it +δjt ]
NS
1
P
≈ NS
i=1 1+ ′ exp[xj ′ t β̃it +δj ′ t ]
j
▶ more sophisticated sampling (“importance sampling”) possible
▶ use this approximation routine every time sj (xt , δt , θ2 ) appears below
▶ use the same set of draws of ζitk each time to avoid “jittering”.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

BLP Estimation Algorithm: More Detail
1. set up approximation of shares via simulation
2. take a trial value of the parameters θ
▶ selected by search algorithm (e.g., Nelder-Meade in BLP).

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

BLP Estimation Algorithm: More Detail
1. set up approximation of shares via simulation
2. take a trial value of the parameters θ
3. start with initial guess at δt0 ∀t
▶ e.g., from MNL or nested logit.

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

BLP Estimation Algorithm: More Detail
1. set up approximation of shares via simulation
2. take a trial value of the parameters θ
3. start with initial guess at δt0 ∀t
4. solve fixed point problem by iterating on the contraction
δjth+1 = δjth + log(shjt ) − log(sj (δ h , xt , θ2 )) ∀j → δjt (θ2 ) ∀jt

▶ convergence tolerance τinner
▶ tempting to make tolerance loose, at least in beginning, but this can lead to big
trouble
▶ better than simple iteration on contraction: “SQUAREM” acceleration method of
Reynaerts, Nash, and Varadahn (2012).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

BLP Estimation Algorithm: More Detail
1. set up approximation of shares via simulation
2. take a trial value of the parameters θ
3. start with initial guess at δt0 ∀t
4. solve fixed point problem by iterating on the contraction
δjth+1 = δjth + log(shjt ) − log(sj (δ h , xt , θ2 )) ∀j → δjt (θ2 ) ∀jt
5. δjt (θ2 ) = xjt β0 − αpjt + ξjt =⇒ ξˆt (θ)
1
6. sample analog of g (ξ(θ)) = JT
Zjt ξˆjt (θ)
7. plug into GMM objective function
8. iterate (from 2) to convergence
Standard errors: standard MSM (e.g., Pakes-Pollard, 1989); formulas in paper based on
J → ∞. See Freyberger (2015) for version when T → ∞.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

“Nonlinear” vs. “Linear” Parameters

Important Simplification:
• θ1 = (α, β0 ) enter objective function linearly

• so given θ2 and Ω, we have closed-form expression for optimal θ1
• so outer loop search only involves θ2 = σ

• (this also makes it natural to interpret the inner loop as solving for all ξjt rather
than all δjt ).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT: AN ALTERNATIVE ALGORITHM

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

The NFP Algorithm
Challenges
• contraction rate (“inner loop”) can be slow
(although recent progress on this, noted already)
• “outer loop” optimization is hard

▶ existence of inner loop often yields highly non-convex optimization problem, search
algo can fail
▶ user-defined tolerances important; can get wrong answer without realizing it
▶ NFP algorithm seems unnecessarily “expensive:” it forces constraints on market shares
and linear parameters hold exactly at every guess of θ2 when we care only about
constraints’ holding at the final solution (but shortcuts turn out to be dangerous!).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Constrained Optimization (“MPEC”) Algorithm
(mathematical programming with equilibrium constraints)

• Dube, Fox, and Su (2012): alternative computation approach for the same
estimator
• the general idea:

▶ NFP is just a routine to solve a constrained optimization problem: minimize GMM
objective function over parameters, subject to constraint that the inner loop fixed
point equations hold
▶ so try off-the-shelf constrained optimization solvers (e.g., Knitro) that work well for
“sufficiently nice” problems
▶ DFS show that certain tricks can (sometimes) make the BLP-MPEC problem
“sufficiently nice.”

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

BLP by MPEC: A Simple Version
• constrained optimization formulation of BLP estimator
min
θ,ξ

ξ′Z ′ Ω Z ′ξ

s.t.

log(shjt ) = log(sj (xt , ξt , θ))
where sj (xt , ξt , θ) ≡

1
NS

NS
X

∀j, t

P
exp[xjt β0 + ξjt + k xjkt ζitk ]
P
P
k
1
+
exp[x
β
+
ξ
+
0
ℓt
ℓt
ℓ
k xℓkt ζit ]
i=1

Note: ξjt treated as parameters (a lot of them!) whose values (along with θ) must—at
the final solution—equate predicted and observed shares.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

BLP by MPEC: Better Version
More Parameters Still
• introduce superfluous parameters g
g′ Ω g

min

θ,ξ,g

g

s.t.

= Z ′ξ

log(shjt ) = log(sj (xt , ξt , θ))
where sj (xt , ξt , θ) ≡

∀j, ti

P
NS
exp[xjt β0 + ξjt + k xjkt ζitk ]
1 X
P
P
NS
1 + ℓ exp[xℓt β0 + ξℓt + k xℓkt ζitk ]
i=1

• even more parameters now, but often faster computation due to sparsity of Hessian
matrix for objective function (see Dube, Fox, Su, 2012).

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

MPEC Algorithm

1. single-step optimization (no inner/outer loop)
2. “canned” optimization algorithms from engineering
▶ some (KNITRO is most popular) also available for Matlab, other matrix languages
▶ Matlab fmincon can work in some cases

3. advantages
▶ no user-defined tolerances or optimization parameters to mess up
▶ solvers designed for constrained optimization problems, so likely more reliable than ad
hoc routines written/adapted by economists.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

MPEC Algorithm
Disadvantages
1. need sparsity to get speed gains (or for solvers to work at all), and this often
vanishes when J large and T small.
2. generally need to code 1st and 2nd derivatives, and may need to work hard to make
problem ”nice” (further tricks in the formulation of the problem to induce useful
sparsity); this can take a long time and introduces heavy problem-specific coding
=⇒ claimed avoidance of dependence on error-prone inputs less clear
[however, “automatic differentiation” is increasingly available].

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Optimization: NFP vs. MPEC?

Naive implementation of either approach can easily fail. But both can work well when
one follows now-established best practices. Both have publicly available
implementations.

The open source pyBLP implementation—discussed in some detail in Conlon and
Gortmaker (2020)—offers a frontier NFP approach incorporating multiple advances and
options. They also have useful online tutorials (google pyBLP) that complement the
published paper. I recommend starting here.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Computation: Bottom Line
BLP is a power tool. Careless use can result in cutting off a finger, or worse—crazy
elasticities. But a few now-standard practices make it possible to work safely, and on a
level far beyond what is possible with simpler tools.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

NEXT:“OPTIMAL INSTRUMENTS”

Computation

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Optimal Instruments: An Important Digression

Loosely
• many possible functions of the exogenous variables X , Z could serve as instruments
• what is the best choice?

• particularly relevant to BLP IV: many subsets/combinations/functions of huge x−jt
could be used
Formally: which unconditional moment conditions yield asymptotic efficiency?

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Supply

Optimal Instruments
• recall θ = (α, β, σ); from Chamberlain (1986) the optimal (but infeasible)
demand-side instruments are


∂ξjt (θ0 )
zt
Djt (zt ) = E
∂θ
• feasible approximations: must not depend on realized demand shocks

(3)

▶ sieve basis or direct approximation
▶ initially explored in BLP 1995
▶ better alternative in BLP 1999; simpler version in Reynaert-Verboven (2014)
▶ alternative basis in Gandhi-Houde (2019) (“differentiation instruments”)
▶ in practice: approximate optimal IV often help substantially
▶ Conlon-Gortmaker (2020): more detail, more options, all available in pyBLP and well
documented.

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

NEXT: BRINGING SUPPLY BACK TO THE MODEL

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Adding the Supply Side Moments
• suppose

mcjt (wjt , ωjt , γ) = wjt γ + ωjt

• recall firm FOC:
sj (δt , xt , σ)
pjt − wjt γ + ωjt −
α



∂sj
∂δjt

−1
=0

• so for any (σ, α, β, γ), we have an implied ωjt

• additional moments for estimation:

E [ωjt (σ, α, β, γ) z̃jt ] = 0
• Note: supply moments depend on demand parameters too; in practice, these often
help precision of demand estimates—σ in particular.

Supply

Supply

Demand

BLP Demand

Discussion

Estimator

Computation

Some Important Extensions and Active Topics
1. micro data, consumer panels, etc. (e.g., Petrin 2002; BLP 2004)
2. asymptotics in T (Freyberger, 2015 )
3. endogenous non-price observables (e.g., Fan, 2013, Berry-Haile 2024)
4. incomplete “consideration sets” (e.g., Goeree, 2008)
5. “multiple discrete choice” (e.g., Hendel, 1999)
6. LASSO selection of covars/instruments (Gillen, Montero, Moon & Shum, 2015)
7. EL estimator (Conlon, 2013)
8. role of functional forms, NP identification (Berry & Haile, 2014,2024)
9. nonparametric estimation/inference (Compiani, 2022)
10. discriminating between models of supply (Berry & Haile, 2014; Backus, Conlon, &
Sinkinson, 2024; Duarte, Magnolfi, Solvsten and Sullivan (2024))

Supply

